<html lang="en">

    <head>
    <meta charset="utf-8">

    <title>Your Accounts</title>

    </head>

    <body style="padding: 10%">
        <h1>Your Accounts</h1>
        <hr>
        <div id="balances"></div>
    </body>

    <script>
        "use strict";
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                accountBalances(this);
            }
        };
        xhttp.open("GET", "/accountdata", true);
        xhttp.send();
        
        function accountBalances(xml) {
            "use strict";
            let xmlDoc = xml.responseXML;

            //console.log(xmlDoc);
            
            let tags = xmlDoc.getElementsByTagName('*');
            for (let i = 1; i < tags.length; (i+=3)) {

                let node = document.createElement("div");

                node.innerHTML += "<h2>" + tags[i].firstChild.nodeValue + "</h2>"; 
                node.innerHTML += "<br><strong>Balance: </strong>" + tags[i+2].firstChild.nodeValue + "<br><br>";
                document.getElementById("balances").appendChild(node);
                
                let withdrawFormNode = document.createElement("form");
                withdrawFormNode.action = "javascript:sendActionXML("+tags[i+1].firstChild.nodeValue+");";
                withdrawFormNode.innerHTML += '<input type="number" min="0.00" step="0.01" name="withdraw" id="withdrawValue' + tags[i+1].firstChild.nodeValue + '">';
                withdrawFormNode.innerHTML += '<input type="submit" value="Withdraw">';
                document.getElementById("balances").appendChild(withdrawFormNode);

                let depositFormNode = document.createElement("form");
                depositFormNode.action = "javascript:sendActionXML("+tags[i+1].firstChild.nodeValue+");";
                depositFormNode.innerHTML += '<input type="number" min="0.00" step="0.01" name="deposit" id="depositValue' + tags[i+1].firstChild.nodeValue + '">';
                depositFormNode.innerHTML += '<input type="submit" value="Deposit"><br><br><hr>';
                document.getElementById("balances").appendChild(depositFormNode);
            }
            //console.log(tags);
        }

        function sendActionXML(i) {
            "use strict";
            //console.log(document.getElementById('withdrawValue'+i).value);
            let accountActionString = '<?xml version="1.0" encoding="UTF-8" ?><'+document.getElementById('withdrawValue'+i).name+'><accountid>' + i + "</accountid>";
            accountActionString += "<amount>" + document.getElementById('withdrawValue'+i).value + "</amount></"+document.getElementById('withdrawValue'+i).name+">";

            let parser = new DOMParser();
            let xmlDoc = parser.parseFromString(accountActionString ,"text/xml");

            console.log(accountActionString);
            // console.log(xmlDoc);
            
            let xhttp2 = new XMLHttpRequest();
            xhttp2.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                    balanceUpdate(this);
                }
            };

            xhttp2.open("POST", "/transaction", true);
            xhttp2.setRequestHeader("Content-type", "application/xml");
            xhttp2.send(accountActionString);
            
        }

        function balanceUpdate(res) {
            "use strict";

            //console.log(res);

            if (res.response === 'true') {
                alert('Success on Withdrawal or Deposit'); 
                setInterval (function(){ window.location.href = "/account";}, 500);
            }
            else {
                alert('Failed to Withdraw or Deposit Money');
                setInterval (function(){ window.location.href = "/account";}, 1000);
            }
        }
    </script>

</html>