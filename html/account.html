<html lang="en">

    <head>
    <meta charset="utf-8">

    <title>Your Accounts</title>

    </head>

    <body style="padding: 10%">
        <h1>Your Accounts</h1>
        <hr>
        <div id="balances"></div>
    </body>

    <script>
        "use strict";
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                accountBalances(this);
            }
        };
        xhttp.open("GET", "/accountdata", true);
        xhttp.send();
        
        function accountBalances(xml) {
            "use strict";
            let xmlDoc = xml.responseXML;

            //console.log(xmlDoc);
            
            let tags = xmlDoc.getElementsByTagName('*');
            for (let i = 1; i < (tags.length-1); (i+=2)) {

                let node = document.createElement("div");

                node.innerHTML += "<h2>Account "+tags[i].firstChild.nodeValue+"</h2>"; 
                node.innerHTML += "<br><strong>Balance: </strong>" + tags[i+1].firstChild.nodeValue + "<br><br>";
                document.getElementById("balances").appendChild(node);
                
                let withdrawFormNode = document.createElement("form");
                withdrawFormNode.action = "javascript:sendActionXML("+tags[i].firstChild.nodeValue+", 1);";
                withdrawFormNode.innerHTML += '<input type="number" min="0.00" step="0.01" name="withdraw" id="withdrawValue' + tags[i].firstChild.nodeValue + '">';
                withdrawFormNode.innerHTML += '<input type="submit" value="Withdraw">';
                document.getElementById("balances").appendChild(withdrawFormNode);

                let depositFormNode = document.createElement("form");
                depositFormNode.action = "javascript:sendActionXML("+tags[i].firstChild.nodeValue+", 2);";
                depositFormNode.innerHTML += '<input type="number" min="0.00" step="0.01" name="deposit" id="depositValue' + tags[i].firstChild.nodeValue + '">';
                depositFormNode.innerHTML += '<input type="submit" value="Deposit">';
                document.getElementById("balances").appendChild(depositFormNode);

                let transferFormNode = document.createElement("form");
                transferFormNode.action = "javascript:sendActionXML("+tags[i].firstChild.nodeValue+", 3);";
                let tmpinnerHTML = '<input type="number" min="0.00" step="0.01" name="transfer" id="transferValue' + tags[i].firstChild.nodeValue + '">';
                tmpinnerHTML += '<select name="transferAmount">';
                for (let j = 1; j < (tags.length-1); (j+=2)) {
                    tmpinnerHTML += '<option value="'+tags[j].firstChild.nodeValue+'">Account'+tags[j].firstChild.nodeValue+'</option>';
                }
                tmpinnerHTML += '<input type="submit" value="Transfer">';
                tmpinnerHTML += '<br><br><hr>';
                transferFormNode.innerHTML = tmpinnerHTML;
                document.getElementById("balances").appendChild(transferFormNode);
            }
            //console.log(tags);
        }

        function sendActionXML(i,actionType) {
            "use strict";
            let accountActionString;

            if (actionType === 1) {
                accountActionString = '<?xml version="1.0" encoding="UTF-8" ?><transaction><action>'+document.getElementById('withdrawValue'+i).name+'</action><accountid>' + i + "</accountid>";
                accountActionString += "<amount>" + document.getElementById('withdrawValue'+i).value + "</amount></transaction>";
            }
            else if (actionType === 2) {
                accountActionString = '<?xml version="1.0" encoding="UTF-8" ?><transaction><action>'+document.getElementById('depositValue'+i).name+'</action><accountid>' + i + "</accountid>";
                accountActionString += "<amount>" + document.getElementById('depositValue'+i).value + "</amount></transaction>";
            }
            else if (actionType === 3){
                accountActionString = '<?xml version="1.0" encoding="UTF-8" ?><transaction><action>'+document.getElementById('depositValue'+i).name+'</action><accountid>' + i + "</accountid>";
                accountActionString += "<amount>" + document.getElementById('depositValue'+i).value + "</amount></transaction>";
            }
            let parser = new DOMParser();
            let xmlDoc = parser.parseFromString(accountActionString ,"text/xml");

            console.log(xmlDoc);
            
            let xhttp2 = new XMLHttpRequest();
            xhttp2.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                    balanceUpdate(this);
                }
            };

            xhttp2.open("POST", "/transaction", true);
            xhttp2.setRequestHeader("Content-type", "application/xml");
            xhttp2.send(accountActionString);
            
        }

        function balanceUpdate(res) {
            "use strict";

            //console.log(res);

            if (res.response === 'true') {
                alert('Success on Withdrawal, Deposit, or Transfer'); 
                // Because chrome doesn't like to wait
                setInterval(function(){ window.location.href = "/account";}, 1000);
            }
            else {
                alert('Failed to Withdraw, Deposit, or Transfer Money');
                // Because chrome doesn't like to wait
                setInterval(function(){ window.location.href = "/account";}, 1000);
            }
        }
    </script>

</html>